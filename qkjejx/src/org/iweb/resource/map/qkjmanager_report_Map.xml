<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "sql-map-2.dtd">
<sqlMap>
	<typeAlias alias="score" type="com.qkj.qkjmanager.domain.Score" />
	<typeAlias alias="vartic" type="com.qkj.qkjmanager.domain.Vartic" />
	<select id="qkjmanager_getVarticsReport" resultClass="vartic" parameterClass="java.util.Map">
		<![CDATA[ 
			select DISTINCT c.uuid,c.*,achecku.user_name acheck_username,mdyu.USER_NAME lm_username,acheckd.dept_cname acheck_deptname,df.dept_cname df_name,
			acd.dept_cname acd_cname,chec.ym cym,chec.state cstate
			from qkj_r_score c 
			left join qkj_r_sonscore ss on(ss.score_id=c.uuid)
			left join s_sys_user achecku on(c.acheck_user=achecku.uuid)
			left join s_sys_user mdyu on(c.lm_user=mdyu.uuid)
			left join s_sys_user cuser on(cuser.UUID=ss.check_user)
			left join s_sys_department acheckd on(acheckd.dept_code=c.acheck_usercode)
			LEFT JOIN s_sys_department df on (df.dept_code=acheckd.parent_dept)
			left JOIN s_sys_department acd on(acd.dept_code=c.acheck_dept)
			left join qkj_t_indexdetail id on(id.uuid=ss.check_index)
			left join qkj_r_check chec on (chec.uuid=c.check_ym)
			
		]]>
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="uuid"><![CDATA[ c.uuid=#uuid# ]]></isNotNull>
			<isNotNull prepend="AND" property="check_ym"><![CDATA[  c.check_ym=#check_ym# ]]></isNotNull>
			<isNotNull prepend="AND" property="acheck_usercode"><![CDATA[  c.acheck_usercode=#acheck_usercode# ]]></isNotNull>
			<isNotNull prepend="AND" property="cym"><![CDATA[  chec.ym like #cym# +'%' ]]></isNotNull>
			
			<isNotEmpty prepend="AND" property="apply_depts" open="(" close=")">
			<![CDATA[ c.acheck_usercode In ]]>
			<iterate property="apply_depts" open="(" close=")" conjunction=" , "> #apply_depts[]#</iterate>
			<isNotEmpty prepend="OR" property="apply_perdepts">
				<![CDATA[ c.acheck_usercode In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ c.acheck_user=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty> 
			<isNotEmpty prepend="OR" property="check_user">
				<![CDATA[cuser.UUID=#check_user#]]>
			</isNotEmpty>
			</isNotEmpty>
			<isEmpty  property="apply_depts">
				<isNotEmpty prepend="AND" property="apply_perdepts">
					<![CDATA[ c.acheck_usercode In ]]>
					<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
					<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ c.acheck_user=#apply_userDouble# ]]></isNotEmpty>
				</isNotEmpty>
			</isEmpty>
		</dynamic>
	</select>
</sqlMap>